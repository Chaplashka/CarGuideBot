<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Купить транспорт</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --accent: #229ED9;
            --bg: #f7f9fa;
            --text: #1b1c1d;
            --card-bg: #fff;
            --shadow: 0 4px 24px rgba(34,158,217,0.08);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #20232a;
                --card-bg: #25272e;
                --text: #f7f9fa;
                --shadow: 0 4px 24px rgba(34,158,217,0.25);
            }
        }
        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .card {
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 28px 22px 20px 22px;
            margin-top: 40px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }
        h2 {
            text-align: center;
            margin-bottom: 28px;
            font-weight: 600;
            font-size: 1.5rem;
        }
        label {
            font-size: 1rem;
            margin-top: 18px;
            margin-bottom: 4px;
            display: block;
            font-weight: 500;
        }
        select, button {
            width: 100%;
            padding: 12px 10px;
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 14px;
            border: 1.5px solid #e2e4e8;
            outline: none;
            box-sizing: border-box;
        }
        select:disabled {
            background: #f2f2f2;
            color: #a0a0a0;
        }
        button {
            background: var(--accent);
            color: #fff;
            border: none;
            font-size: 1.08rem;
            font-weight: 600;
            box-shadow: 0 2px 12px rgba(34,158,217,0.13);
            transition: background 0.2s, transform 0.1s;
            margin-top: 14px;
            cursor: pointer;
        }
        button:active {
            background: #0d6ca0;
            transform: scale(0.97);
        }
        @media (max-width: 500px) {
            .card {
                margin-top: 12vw;
                padding: 7vw 4vw 4vw 4vw;
                border-radius: 18px;
            }
            h2 {
                font-size: 1.16rem;
            }
        }
    </style>
</head>
<body>
<div class="card">
    <h2>Купить транспорт</h2>
    <label for="vehicleType">Тип транспорта</label>
    <select id="vehicleType">
        <option value="">Выберите тип</option>
        <option value="PASSENGER_CAR_DATA">Легковой автомобиль</option>
        <option value="COMMERCIAL_VEHICLE_DATA">Коммерческий транспорт</option>
    </select>

    <div id="commercial-fields" style="display: none;">
        <label for="commercialCategory">Вид транспорта</label>
        <select id="commercialCategory" disabled>
            <option value="">Сначала выберите тип</option>
        </select>
    </div>

    <label for="brand">Марка</label>
    <select id="brand" disabled>
        <option value="">Сначала выберите тип</option>
    </select>
    <label for="model">Модель</label>
    <select id="model" disabled>
        <option value="">Сначала выберите марку</option>
    </select>
    <div id="generation-fields">
        <label for="generation">Поколение</label>
        <select id="generation" disabled>
            <option value="">Сначала выберите модель</option>
        </select>
    </div>
    <button onclick="sendData()">Отправить</button>
</div>
<script>
    let allData = {};
    let carData = {};
    let currentType = '';
    let commercialMode = false;
    const vehicleTypeSelect = document.getElementById('vehicleType');
    const commercialFields = document.getElementById('commercial-fields');
    const commercialCategorySelect = document.getElementById('commercialCategory');
    const brandSelect = document.getElementById('brand');
    const modelSelect = document.getElementById('model');
    const genFields = document.getElementById('generation-fields');
    const genSelect = document.getElementById('generation');
    const DATA_URL = 'https://chaplashka.github.io/CarGuideBot/car_data.json';

    fetch(DATA_URL)
        .then(response => response.json())
        .then(data => {
            allData = data;
            vehicleTypeSelect.disabled = false;
        })
        .catch(e => {
            alert('Ошибка загрузки данных: ' + e);
        });

    vehicleTypeSelect.addEventListener('change', function() {
        currentType = this.value;
        if (!currentType) {
            commercialFields.style.display = 'none';
            brandSelect.disabled = true;
            modelSelect.disabled = true;
            genFields.style.display = '';
            genSelect.disabled = true;
            brandSelect.innerHTML = '<option value="">Сначала выберите тип</option>';
            modelSelect.innerHTML = '<option value="">Сначала выберите марку</option>';
            genSelect.innerHTML = '<option value="">Сначала выберите модель</option>';
            return;
        }
        // Для коммерческих включаем отдельную логику
        if (currentType === 'COMMERCIAL_VEHICLE_DATA') {
            commercialMode = true;
            commercialFields.style.display = '';
            genFields.style.display = 'none'; // нет поколения!
            let categories = Object.keys(allData[currentType] || {});
            commercialCategorySelect.innerHTML = '<option value="">Выберите вид</option>';
            categories.forEach(category => {
                let opt = document.createElement('option');
                opt.value = category;
                opt.innerText = category;
                commercialCategorySelect.appendChild(opt);
            });
            commercialCategorySelect.disabled = false;

            // Сбросить всё ниже
            brandSelect.innerHTML = '<option value="">Сначала выберите вид транспорта</option>';
            brandSelect.disabled = true;
            modelSelect.innerHTML = '<option value="">Сначала выберите марку</option>';
            modelSelect.disabled = true;
        } else {
            // Легковые
            commercialMode = false;
            commercialFields.style.display = 'none';
            genFields.style.display = '';
            carData = allData[currentType] || {};
            brandSelect.innerHTML = '<option value="">Выберите марку</option>';
            Object.keys(carData).forEach(brand => {
                let opt = document.createElement('option');
                opt.value = brand;
                opt.innerText = brand;
                brandSelect.appendChild(opt);
            });
            brandSelect.disabled = false;
            modelSelect.innerHTML = '<option value="">Сначала выберите марку</option>';
            modelSelect.disabled = true;
            genSelect.innerHTML = '<option value="">Сначала выберите модель</option>';
            genSelect.disabled = true;
        }
    });

    commercialCategorySelect.addEventListener('change', function() {
        // Заполняем марки
        const cat = this.value;
        brandSelect.innerHTML = '<option value="">Выберите марку</option>';
        brandSelect.disabled = !cat;
        modelSelect.innerHTML = '<option value="">Сначала выберите марку</option>';
        modelSelect.disabled = true;
        if (!cat) return;
        carData = allData['COMMERCIAL_VEHICLE_DATA'][cat] || {};
        Object.keys(carData).forEach(brand => {
            let opt = document.createElement('option');
            opt.value = brand;
            opt.innerText = brand;
            brandSelect.appendChild(opt);
        });
    });

    brandSelect.addEventListener('change', function() {
        modelSelect.innerHTML = '<option value="">Выберите модель</option>';
        modelSelect.disabled = !this.value;
        if (commercialMode) {
            // Для коммерческих — после модели всё, поколений нет!
            if (!this.value) return;
            const models = carData[this.value] || [];
            models.forEach(model => {
                let opt = document.createElement('option');
                opt.value = model;
                opt.innerText = model;
                modelSelect.appendChild(opt);
            });
        } else {
            // Для легковых
            genSelect.innerHTML = '<option value="">Сначала выберите модель</option>';
            genSelect.disabled = true;
            if (!this.value) return;
            const models = carData[this.value] || {};
            Object.keys(models).forEach(model => {
                let opt = document.createElement('option');
                opt.value = model;
                opt.innerText = model;
                modelSelect.appendChild(opt);
            });
        }
    });

    modelSelect.addEventListener('change', function() {
        if (commercialMode) {
            // Для коммерческих — ничего не делаем, на модели всё заканчивается!
            return;
        }
        genSelect.innerHTML = '<option value="">Выберите поколение</option>';
        genSelect.disabled = !this.value;
        if (!this.value) return;
        const brand = brandSelect.value;
        const generations = carData[brand] && carData[brand][this.value] ? carData[brand][this.value] : [];
        generations.forEach(generation => {
            let opt = document.createElement('option');
            opt.value = generation;
            opt.innerText = generation;
            genSelect.appendChild(opt);
        });
    });

    function sendData() {
        const type = vehicleTypeSelect.value;
        let data = { type };
        if (type === 'COMMERCIAL_VEHICLE_DATA') {
            const category = commercialCategorySelect.value;
            const brand = brandSelect.value;
            const model = modelSelect.value;
            if (!category || !brand || !model) {
                alert('Пожалуйста, выберите все параметры!');
                return;
            }
            data.category = category;
            data.brand = brand;
            data.model = model;
        } else {
            // Легковые
            const brand = brandSelect.value;
            const model = modelSelect.value;
            const generation = genSelect.value;
            if (!brand || !model || !generation) {
                alert('Пожалуйста, выберите все параметры!');
                return;
            }
            data.brand = brand;
            data.model = model;
            data.generation = generation;
        }
        Telegram.WebApp.sendData(JSON.stringify(data));
    }
</script>
</body>
</html>
